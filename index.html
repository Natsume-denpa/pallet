<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WHITE PALETTE</title>
    <style>
        :root {
            --bg: #f8f9fa;
            --canvas-bg: #ffffff;
            --accent: #1a1a1a;
            --text: #333;
            --border: #e0e0e0;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        header {
            padding: 10px 0;
            text-align: center;
            flex-shrink: 0;
        }
        h1 {
            font-size: 0.9rem;
            font-weight: 300;
            letter-spacing: 4px;
            margin: 0;
            color: #888;
        }

        #stage {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            min-height: 0;
        }

        .canvas-outer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-container {
            width: 100%;
            max-width: 600px;
            max-height: 100%;
            aspect-ratio: 1 / 1;
            background: var(--canvas-bg);
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            position: relative;
            cursor: pointer;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
            object-fit: contain;
        }

        .controls {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 100%;
            padding: 15px 10px calc(15px + env(safe-area-inset-bottom));
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            border-top: 1px solid var(--border);
            max-width: 600px;
            margin: 0 auto;
            flex-shrink: 0;
        }

        .btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            font-size: 10px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            gap: 6px;
            padding: 0;
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:active .btn-icon {
            transform: scale(0.92);
            background: #f0f0f0;
        }

        .btn-primary .btn-icon {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        #fileInput { display: none; }

        .guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #bbb;
            pointer-events: none;
            text-align: center;
            width: 80%;
            transition: opacity 0.3s;
        }
        
        .guide p { margin: 5px 0; font-size: 13px; }

        @media (min-width: 768px) {
            .btn-icon:hover {
                background: #f8f8f8;
                border-color: #bbb;
            }
            .btn-primary .btn-icon:hover {
                background: #333;
            }
        }
    </style>
</head>
<body>

<header>
    <h1>WHITE PALETTE</h1>
</header>

<div id="stage">
    <div class="canvas-outer">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
            <div id="guideText" class="guide">
                <p style="font-size: 32px; font-weight: 100;">Ôºã</p>
                <p>ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</p>
            </div>
        </div>
    </div>
</div>

<div class="controls">
    <label class="btn btn-primary">
        <div class="btn-icon">Ôºã</div>
        <span>ËøΩÂä†</span>
        <input type="file" id="fileInput" accept="image/*" multiple>
    </label>
    
    <button class="btn" id="saveBtn">
        <div class="btn-icon">‚Üì</div>
        <span>‰øùÂ≠ò</span>
    </button>

    <button class="btn" id="tweetBtn">
        <div class="btn-icon">ùïè</div>
        <span>ÊäïÁ®ø</span>
    </button>

    <button class="btn" id="clearBtn">
        <div class="btn-icon">√ó</div>
        <span>Ê∂àÂéª</span>
    </button>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('fileInput');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const tweetBtn = document.getElementById('tweetBtn');
    const guideText = document.getElementById('guideText');
    const canvasContainer = document.getElementById('canvasContainer');

    const RESOLUTION = 1200;
    canvas.width = RESOLUTION;
    canvas.height = RESOLUTION;

    let grid = [];
    const gridSize = 4;

    function init() {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, RESOLUTION, RESOLUTION);
        
        grid = [];
        const step = RESOLUTION / gridSize;
        for(let y=0; y<gridSize; y++) {
            for(let x=0; x<gridSize; x++) {
                grid.push({
                    x: x * step + step/2,
                    y: y * step + step/2
                });
            }
        }
		
        grid.sort(() => Math.random() - 0.5);
        guideText.style.opacity = '1';
    }

    init();

    canvasContainer.onclick = (e) => {
        if(e.target !== fileInput) fileInput.click();
    };

    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if(files.length > 0) guideText.style.opacity = '0';
        
        for (const file of files) {
            await processFile(file);
        }
        fileInput.value = "";
    });

    function processFile(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    drawPhoto(img);
                    resolve();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    function drawPhoto(img) {
        let x, y;
        if(grid.length > 0) {
            const point = grid.shift();
            x = point.x + (Math.random() - 0.5) * (RESOLUTION/gridSize * 0.8);
            y = point.y + (Math.random() - 0.5) * (RESOLUTION/gridSize * 0.8);
        } else {
            x = Math.random() * RESOLUTION;
            y = Math.random() * RESOLUTION;
        }

        const scale = (Math.random() * 0.15) + 0.3;
        const w = RESOLUTION * scale;
        const h = (img.height / img.width) * w;
        const angle = (Math.random() - 0.5) * 0.6;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);

        ctx.shadowColor = 'rgba(0,0,0,0.15)';
        ctx.shadowBlur = 30;
        ctx.shadowOffsetY = 5;
        
        const border = w * 0.04;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(-w/2 - border, -h/2 - border, w + border*2, h + border*2);

        ctx.shadowBlur = 0;
        ctx.shadowOffsetY = 0;
        ctx.drawImage(img, -w/2, -h/2, w, h);
        ctx.restore();
    }

    saveBtn.onclick = (e) => {
        e.stopPropagation();
        const link = document.createElement('a');
        link.download = 'WhitePalette.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    };

    tweetBtn.onclick = (e) => {
        e.stopPropagation();
        const text = encodeURIComponent("‰ªäÂπ¥„ÅÆ‰∏ÄÂπ¥„Çí„Åæ„Å®„ÇÅ„Åæ„Åó„Åü„ÄÇ #WhitePalette");
        window.open(`https://twitter.com/intent/tweet?text=${text}`);
    };

    clearBtn.onclick = (e) => {
        e.stopPropagation();
        if(confirm('„Éë„É¨„ÉÉ„Éà„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) init();
    };
</script>

</body>
</html>
